<div class="card">
  <h3>Add Sale</h3>
  <div class="col-12">
    <form #saleForm="ngForm" (ngSubmit)="onSubmit()">
      <div class="p-fluid p-formgrid grid">

        <!-- Sale Date -->
        <div class="field col-12 md:col-4">
          <app-input-date label="Date" [(ngModel)]="saleDate" name="saleDate" />
        </div>

        <!-- Reference No -->
        <div class="field col-12 md:col-4">
          <app-input-text label="Reference No" [(ngModel)]="item.referenceNo" name="referenceNo" />
        </div>

        <!-- Warehouse -->
        <div class="field col-12 md:col-4">
          <app-input-select label="Warehouse" [(ngModel)]="item.warehouseId" name="warehouseId"
            [options]="optionsDataSources?.warehousesSelectList" />
        </div>

        <!-- Customer -->
        <div class="field col-12 md:col-4">
          <app-input-select label="Customer" [(ngModel)]="item.customerId" name="customerId"
            [options]="optionsDataSources?.customersSelectList" />
        </div>

        <!-- Biller -->
        <div class="field col-12 md:col-4">
          <app-input-select label="Biller" [(ngModel)]="item.billerId" name="billerId"
            [options]="optionsDataSources?.bullersSelectList" />
        </div>

        <!-- product select  -->
        <div class="col-12">
          <app-input-select label="" [optionValue]="null" name="selectedProduct" [(ngModel)]="selectedProduct"
            (ngModelChange)="onProductSelect()" [options]="optionsDataSources?.['productsSelectList']" />
        </div>

        <!-- Sale Details List -->
        <div class="col-12">
          <p-table [value]="item.saleDetails" [scrollable]="true" scrollHeight="600px">
            <ng-template pTemplate="header">
              <tr>
                <th style="min-width:100px">Name</th>
                <th style="min-width:70px">Code</th>
                <th style="min-width:70px">Quantity</th>
                <th style="min-width:70px">Unit Price</th>
                <th style="min-width:70px">Discount</th>
                <th style="min-width:70px">Tax</th>
                <th style="min-width:70px">Sub Total</th>
                <th style="min-width:50px">Del</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-detail let-i="rowIndex">
              <tr>
                <td>{{ detail.productName }}</td>
                <td>{{ detail.productCode }}</td>
                <td>
                  <app-input-number [(ngModel)]="detail.quantity" name="quantity-{{i}}" [showButtons]="true" [min]="1"
                    (ngModelChange)="onItemPropsChange(detail)" />
                </td>
                <td>
                  <app-input-decimal [(ngModel)]="detail.netUnitPrice" name="unitPrice-{{i}}" />
                </td>
                <td>
                  <app-input-decimal [(ngModel)]="detail.productUnitDiscount" name="productUnitDiscount-{{i}}"
                    (ngModelChange)="onItemPropsChange(detail)" />
                  {{ detail.discountAmount }}
                </td>
                <td>
                  <app-input-decimal [(ngModel)]="detail.taxAmount" name="taxAmount-{{i}}"
                    (ngModelChange)="onItemPropsChange(detail)" />
                </td>
                <td>{{ detail.totalPrice }}</td>
                <td>
                  <app-button type="button" severity="danger" icon="pi pi-trash" (click)="onRemoveSaleDetail(i)" />
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr class="text-center">
                <td colspan="2" class="text-left">Total</td>
                <td>{{ getTotalQuantity() }}</td>
                <td></td>
                <td>{{ getTotalDiscount() }}</td>
                <td>{{ getTotalTax() }}</td>
                <td>{{ getSubTotalOfTotal() }}</td>
                <td></td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <!-- Tax -->
        <div class="field col-12 md:col-4">
          <app-input-select label="Order Tax" name="taxRate" [(ngModel)]="item.taxRate"
            [options]="optionsDataSources?.['taxesSelectList']" [required]="true"
            (ngModelChange)="onOrderTaxChange()" />
        </div>

        <div class="field col-12 md:col-4">
          <app-input-select label="Discount Type" [(ngModel)]="item.discountType" name="discountType"
            [options]="discountTypes" (ngModelChange)="onDiscountTypeChange()" />
        </div>

        <!-- Discount Rate -->
        <div class="field col-12 md:col-4" *ngIf="item.discountType === DiscountType.Percentage">
          <app-input-decimal label="Discount Rate" [(ngModel)]="item.discountRate" name="discountRate" (ngModelChange)="onDiscountRateChange()" />
        </div>

        <!-- Discount Amount -->
        <div class="field col-12 md:col-4" *ngIf="item.discountType === DiscountType.Fixed">
          <app-input-decimal label="Discount Amount" [(ngModel)]="item.discountAmount" name="discountAmount" (ngModelChange)="onDiscountAmountChange()" />
        </div>

        <!-- Shipping Cost -->
        <div class="field col-12 md:col-4">
          <app-input-decimal label="Shipping Cost" [(ngModel)]="item.shippingCost" name="shippingCost" (ngModelChange)="onShippingCostChange()" />
        </div>

        <!-- Sale Status -->
        <div class="field col-12 md:col-4">
          <app-input-select label="Sale Status" [(ngModel)]="item.saleStatusId" name="saleStatusId"
            [options]="optionsDataSources?.saleStatusSelectList" />
        </div>

        <!-- Payment Status -->
        <div class="field col-12 md:col-4">
          <app-input-select label="Payment Status" [(ngModel)]="item.paymentStatusId" name="paymentStatusId"
            [options]="optionsDataSources?.paymentStatusSelectList" />
        </div>

        <!-- Attachment -->
        <div class="mt-3 field col-12 md:col-12">
          <app-input-file-adv [maxFileSize]="100000000" mode="basic" location="images"
            (fileUrlsChange)="onFileUpload($event)" />
        </div>

        <!-- Sale Note -->
        <div class="field col-12 md:col-6">
          <app-input-textarea label="Sale Note" [(ngModel)]="item.saleNote" name="saleNote" />
        </div>

        <!-- Staff Note -->
        <div class="field col-12 md:col-6">
          <app-input-textarea label="Staff Note" [(ngModel)]="item.staffNote" name="staffNote" />
        </div>


      </div>
      <div class="col-12">
        <table width="100%" style="text-align: right;">
          <tbody>
            <tr>
              <td class="" colspan="4">
                <strong>Items</strong>
              </td>
              <td class="">
                <span>{{totalItems}}</span>
              </td>
            </tr>
            <tr>
              <td class="" colspan="4">
                <strong>Total</strong>
              </td>
              <td class="">
                <span>{{ getSubTotalOfTotal() }}</span>
              </td>
            </tr>
            <tr>
              <td class="" colspan="4">
                <strong>Order Tax</strong>
              </td>
              <td class="">
                <span>{{ item.taxAmount }}</span>
              </td>
            </tr>
            <tr>
              <td class="" colspan="4">
                <strong>Order Discount</strong>
              </td>
              <td class="">
                <span>{{ item.discountAmount }}</span>
              </td>
            </tr>
            <tr>
              <td class="" colspan="4">
                <strong>Shipping Cost</strong>
              </td>
              <td class="">
                <span>{{ item.shippingCost }}</span>
              </td>
            </tr>
            <tr>
              <td class="" colspan="4">
                <strong>Grand Total</strong>
              </td>
              <td class="font-bold">
                <span>{{ item.grandTotal }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>


      <!-- Form Actions -->
      <div class="mt-3 p-dialog-footer">
        <app-button label="Save" type="submit" [outlined]="true" icon="pi pi-check" [disabled]="!saleForm.valid" />
      </div>
    </form>
  </div>
</div>